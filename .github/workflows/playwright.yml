name: Playwright Tests with Allure Report

on:
  push:
    branches: [ main ] # àª¤àª®àª¾àª°à«€ àª®à«àª–à«àª¯ àª¬à«àª°àª¾àª¨à«àªšàª¨à«àª‚ àª¨àª¾àª®

jobs:
  playwright_tests:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repository code
        uses: actions/checkout@v4

      # à«§. Node.js àª…àª¨à«‡ Playwright àª¬àª¾àªˆàª¨àª°à«€àª àª¸à«‡àªŸàª…àªª àª•àª°à«‹
      - name: ðŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # àª¤àª®àª¾àª°àª¾ àªªà«àª°à«‹àªœà«‡àª•à«àªŸ àª®à«àªœàª¬ àªµàª°à«àªàª¨ àª¬àª¦àª²à«€ àª¶àª•à«‹ àª›à«‹

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: âš™ï¸ Install Playwright browsers
        run: npx playwright install --with-deps

      # à«¨. Playwright Tests àª¨à«‡ Allure àª¸àª¾àª¥à«‡ àª°àª¨ àª•àª°à«‹
      - name: ðŸƒ Run Playwright tests and generate Allure results
        # àª–àª¾àª¤àª°à«€ àª•àª°à«‹ àª•à«‡ àª¤àª®àª¾àª°àª¾ package.json àª®àª¾àª‚ 'allure-playwright' àª‡àª¨à«àª¸à«àªŸà«‹àª² àª¥àª¯à«‡àª²à«àª‚ àª›à«‡
        # àª…àª¨à«‡ 'playwright.config.ts' àª®àª¾àª‚ Allure àª°àª¿àªªà«‹àª°à«àªŸàª° àª¸à«‡àªŸ àª•àª°à«‡àª² àª›à«‡.
        # Playwright CLI àª®àª¾àª‚ Allure àª°àª¿àªªà«‹àª°à«àªŸàª° àª¸à«‡àªŸ àª¹à«‹àª¯ àª¤à«‹ àª† àª•àª®àª¾àª¨à«àª¡ àªšàª¾àª²àª¶à«‡.
        run: npx playwright test --reporter=line,allure

      - name: ðŸ’¾ Upload Allure results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results # Playwright àª¦à«àªµàª¾àª°àª¾ àªœàª¨àª°à«‡àªŸ àª¥àª¯à«‡àª²à«€ àª¡àª¿àª°à«‡àª•à«àªŸàª°à«€
          retention-days: 5

  # à«©. Allure Report àª¬àª¨àª¾àªµà«‹ àª…àª¨à«‡ GitHub Pages àªªàª° àªªàª¬à«àª²àª¿àª¶ àª•àª°à«‹
  build_and_publish_report:
    needs: playwright_tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: ðŸ“ Generate Allure Report and Publish to GitHub Pages
        # àª† àªàª•à«àª¶àª¨ àª“àªŸà«‹àª®à«‡àªŸà«€àª• àª°àª¿àªªà«‹àª°à«àªŸ àªœàª¨àª°à«‡àªŸ àª•àª°à«€àª¨à«‡ gh-pages àª¬à«àª°àª¾àª¨à«àªš àªªàª° àª®à«‚àª•à«€ àª¦à«‡àª¶à«‡
        uses: simple-elf/allure-report-action@v1.7
        if: always() # àª­àª²à«‡ àªŸà«‡àª¸à«àªŸ àª«à«‡àª² àª¥àª¾àª¯, àª°àª¿àªªà«‹àª°à«àªŸ àª¤à«‹ àª¬àª¨àª¾àªµàªµà«‹ àªœ àª›à«‡
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # à«ª. àª°àª¿àªªà«‹àª°à«àªŸ àª²àª¿àª‚àª• àª®à«‡àª³àªµàªµàª¾ àª®àª¾àªŸà«‡
      - name: âœ¨ Get Allure Report URL (One-Click Link)
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report/"
          echo "Allure Report is available at: $REPORT_URL"
          echo "REPORT_URL=$REPORT_URL" >> $GITHUB_ENV # Enviroment variable àª®àª¾àª‚ àª¸à«‡àªµ àª•àª°à«‹