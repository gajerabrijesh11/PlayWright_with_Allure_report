name: Playwright Tests with Allure Report

on:
  push:
    branches: [ main ]

jobs:
  playwright_tests:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repository code
        uses: actions/checkout@v4

      
      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: âš™ï¸ Install Playwright browsers
        run: npx playwright install --with-deps

      
      - name: ğŸƒ Run Playwright tests and generate Allure results
        
        run: npx playwright test

      - name: ğŸ’¾ Upload Allure results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results 
          retention-days: 5
        if: always()

  
  build_and_publish_report:
    if: always()
    needs: playwright_tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results
        if: always()

      - name: ğŸŸ¢ Set up Node.js for CLI
        uses: actions/setup-node@v4
        with:
          node-version: 20
        if: always()

      
      - name: ğŸ“¦ Install Allure CLI
        
        run: npm install -g allure-commandline --save-dev
        if: always()

      
      - name: ğŸ“ Generate Allure Report using CLI
        run: allure generate allure-results --clean -o allure-report
        if: always()

      
      - name: ğŸš€ Deploy using Git CLI
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          
          git add allure-report
          git commit -m "Deploy Allure Report to GitHub Pages"
        
          
          
          git push -f https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:gh-pages
        if: always()

      - name: âœ¨ Get Allure Report URL (One-Click Link)
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report/"
          echo "Allure Report is available at: $REPORT_URL"
        if: always()