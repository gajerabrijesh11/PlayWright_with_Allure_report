name: Playwright Tests with Allure Report

on:
  push:
    branches: [ main ] # ркдркорк╛рк░рлА ркорлБркЦрлНркп ркмрлНрк░рк╛ркирлНркЪркирлБркВ ркирк╛рко

jobs:
  playwright_tests:
    runs-on: ubuntu-latest
    steps:
      - name: тмЗя╕П Checkout repository code
        uses: actions/checkout@v4

      # рлз. Node.js ркЕркирлЗ Playwright ркмрк╛ркИркирк░рлАркЭ рк╕рлЗркЯркЕркк ркХрк░рлЛ
      - name: ЁЯЯв Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # ркдркорк╛рк░рк╛ рккрлНрк░рлЛркЬрлЗркХрлНркЯ ркорлБркЬркм рк╡рк░рлНркЭрки ркмркжрк▓рлА рк╢ркХрлЛ ркЫрлЛ

      - name: ЁЯУж Install dependencies
        run: npm install

      - name: тЪЩя╕П Install Playwright browsers
        run: npx playwright install --with-deps

      # рли. Playwright Tests ркирлЗ Allure рк╕рк╛ркерлЗ рк░рки ркХрк░рлЛ
      - name: ЁЯПГ Run Playwright tests and generate Allure results
        # ркЦрк╛ркдрк░рлА ркХрк░рлЛ ркХрлЗ ркдркорк╛рк░рк╛ package.json ркорк╛ркВ 'allure-playwright' ркЗркирлНрк╕рлНркЯрлЛрк▓ ркеркпрлЗрк▓рлБркВ ркЫрлЗ
        # ркЕркирлЗ 'playwright.config.ts' ркорк╛ркВ Allure рк░рк┐рккрлЛрк░рлНркЯрк░ рк╕рлЗркЯ ркХрк░рлЗрк▓ ркЫрлЗ.
        # Playwright CLI ркорк╛ркВ Allure рк░рк┐рккрлЛрк░рлНркЯрк░ рк╕рлЗркЯ рк╣рлЛркп ркдрлЛ ркЖ ркХркорк╛ркирлНркб ркЪрк╛рк▓рк╢рлЗ.
        run: npx playwright test

      - name: ЁЯТ╛ Upload Allure results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results # Playwright ркжрлНрк╡рк╛рк░рк╛ ркЬркирк░рлЗркЯ ркеркпрлЗрк▓рлА ркбрк┐рк░рлЗркХрлНркЯрк░рлА
          retention-days: 5

  # рлй. Allure Report ркмркирк╛рк╡рлЛ ркЕркирлЗ GitHub Pages рккрк░ рккркмрлНрк▓рк┐рк╢ ркХрк░рлЛ
  build_and_publish_report:
    needs: playwright_tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: тмЗя╕П Checkout code
        uses: actions/checkout@v4

      - name: ЁЯУе Download Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: ЁЯЯв Set up Node.js for CLI
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ЁЯТе ркирк╡рлБркВ рккркЧрк▓рлБркВ: Allure Commandline ркЯрлВрк▓ ркЗркирлНрк╕рлНркЯрлЛрк▓ ркХрк░рлЛ
      - name: ЁЯУж Install Allure CLI
        # ркЖ Allure CLI ркирлЗ ркЧрлНрк▓рлЛркмрк▓рлА ркЗркирлНрк╕рлНркЯрлЛрк▓ ркХрк░рк╢рлЗ
        run: npm install -g allure-commandline --save-dev

      # ЁЯТе ркирк╡рлБркВ рккркЧрк▓рлБркВ: Allure Report ркЬркирк░рлЗркЯ ркХрк░рлЛ
      - name: ЁЯУЭ Generate Allure Report using CLI
        run: allure generate allure-results --clean -o allure-report

      # рлк. рк░рк┐рккрлЛрк░рлНркЯ рк▓рк┐ркВркХ ркорлЗрк│рк╡рк╡рк╛ ркорк╛ркЯрлЗ
      - name: ЁЯЪА Deploy using Git CLI
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          # 'allure-report' рклрлЛрк▓рлНркбрк░ркирлЗ ркПркХ ркирк╡рк╛ ркХркорк┐ркЯ рк╕рк╛ркерлЗ gh-pages ркмрлНрк░рк╛ркирлНркЪркорк╛ркВ рккрлБрк╢ ркХрк░рлЛ
          git add allure-report
          git commit -m "Deploy Allure Report to GitHub Pages"
          
          # Forcefully рккрлБрк╢ ркХрк░рлЛ
          git push -f https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:gh-pages

      - name: тЬи Get Allure Report URL (One-Click Link)
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report/"
          echo "Allure Report is available at: $REPORT_URL"